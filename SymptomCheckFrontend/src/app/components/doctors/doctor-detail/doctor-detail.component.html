<!-- doctor-detail.component.html -->
<div *ngIf="isLoading" class="loading-container">
  <div class="loading-spinner"></div>
  <p>Loading doctor information...</p>
</div>

<div *ngIf="error" class="error-container">
  <div class="error-icon">⚠️</div>
  <p class="error-message">{{ error }}</p>
  <button class="btn btn-secondary" routerLink="/doctors">Back to Doctors</button>
</div>

<div *ngIf="doctor && !isLoading" class="doctor-detail-container">
  <div class="doctor-profile">
    <div class="left-section">
      <img
        [src]="getUserImage(doctor?.profilePhotoUrl)"
        alt="Doctor's photo"
        class="profile-photo"
      />
    </div>
    <div class="right-section">
      <h2 class="doctor-name">
        {{ doctor.firstName }} {{ doctor.lastName }}
      </h2>
      
      <!-- Section Rating avec statistiques -->
      <div class="rating-section">
        <app-star-rating [rating]="averageRating" [readOnly]="true"></app-star-rating>
        <span class="rating-text">
          {{ averageRating | number:'1.1-1' }} ({{ totalReviews }} reviews)
        </span>
      </div>

      <div class="doctor-info">
        <p><i class="fas fa-user-md"></i> <strong>Speciality:</strong> {{ doctor.speciality }}</p>
        <p><i class="fas fa-envelope"></i> <strong>Email:</strong> {{ doctor.email }}</p>
        <p><i class="fas fa-phone"></i> <strong>Phone:</strong> {{ doctor.phoneNumber }}</p>
        <p *ngIf="doctor.description"><i class="fas fa-file-alt"></i> <strong>Description:</strong> {{ doctor.description }}</p>
        <p *ngIf="doctor.diploma"><i class="fas fa-certificate"></i> <strong>Diploma:</strong> {{ doctor.diploma }}</p>
        <p *ngIf="doctor.clinicId"><i class="fas fa-clinic-medical"></i> <strong>Clinic ID:</strong> {{ doctor.clinicId }}</p>
      </div>

      <!-- Bouton Review pour les patients seulement -->
      <div *ngIf="currentUser?.roles?.includes(UserRole.PATIENT)" class="review-actions">
        <button 
          class="btn btn-primary" 
          (click)="toggleReviewForm()"
          *ngIf="!hasUserReviewed; else editReview">
          <i class="fas fa-edit"></i> Leave a Review
        </button>
        
        <ng-template #editReview>
          <div class="user-review-actions">
            <button class="btn btn-outline-primary" (click)="toggleReviewForm()">
              <i class="fas fa-edit"></i> Edit Your Review
            </button>
            <button class="btn btn-outline-danger" (click)="deleteReview()">
              <i class="fas fa-trash"></i> Delete Review
            </button>
          </div>
        </ng-template>
      </div>

      <!-- Formulaire de review -->
      <div *ngIf="showReviewForm" class="review-form">
        <h3>{{ hasUserReviewed ? 'Edit Your Review' : 'Write a Review' }}</h3>
        <form [formGroup]="reviewForm" (ngSubmit)="submitReview()">
          <div class="form-group">
            <label>Rating:</label>
            <app-star-rating
              formControlName="rating"
              [readOnly]="false">
            </app-star-rating>
            <div *ngIf="reviewForm.get('rating')?.invalid && reviewForm.get('rating')?.touched" 
                 class="error-message">
              Rating is required
            </div>
          </div>
          
          <div class="form-group">
            <label for="comment">Comment:</label>
            <textarea
              id="comment"
              formControlName="comment"
              class="form-control"
              rows="4"
              placeholder="Share your experience with this doctor..."
              maxlength="2000"></textarea>
            <div class="char-count" 
                 [class.near-limit]="isNearLimit"
                 [class.over-limit]="isOverLimit">
              {{ commentLength }}/2000
            </div>
            <div *ngIf="reviewForm.get('comment')?.invalid && reviewForm.get('comment')?.touched" 
                 class="error-message">
              <span *ngIf="reviewForm.get('comment')?.errors?.['required']">Comment is required</span>
              <span *ngIf="reviewForm.get('comment')?.errors?.['maxlength']">Comment must be less than 2000 characters</span>
            </div>
          </div>
          
          <div class="form-actions">
            <button
              type="submit"
              class="btn btn-primary"
              [disabled]="reviewForm.invalid || isOverLimit">
              {{ hasUserReviewed ? 'Update Review' : 'Submit Review' }}
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              (click)="toggleReviewForm()">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Section des reviews -->
  <div class="reviews-section" *ngIf="reviews.length > 0">
    <h3>Patient Reviews ({{ totalReviews }})</h3>
    
    <!-- Review de l'utilisateur courant -->
    <div *ngIf="userReview" class="review-card user-review">
      <div class="review-header">
        <div class="review-rating">
          <app-star-rating [rating]="userReview.rating" [readOnly]="true"></app-star-rating>
         <!-- <span class="review-label">Your Review</span>-->
        </div>
        <span class="review-date">{{ formatDate(userReview.datePosted) }}</span>
      </div>
      <p class="review-comment">{{ userReview.comment }}</p>
    </div>

    <!-- Autres reviews (exclure le review de l'utilisateur) -->
    <div *ngFor="let review of reviews">
      <div *ngIf="!userReview || review.id !== userReview.id" class="review-card">
        <div class="review-header">
          <app-star-rating [rating]="review.rating" [readOnly]="true"></app-star-rating>
          <span class="review-date">{{ formatDate(review.datePosted) }}</span>
        </div>
        <p class="review-comment">
          {{ review.comment }}
        </p>
      </div>
    </div>
  </div>

  <div *ngIf="reviews.length === 0 && !isLoading" class="no-reviews">
    <p>No reviews yet. Be the first to review this doctor!</p>
    <button 
      *ngIf="currentUser?.roles?.includes(UserRole.PATIENT) && !hasUserReviewed"
      class="btn btn-primary" 
      (click)="toggleReviewForm()">
      Be the First to Review
    </button>
  </div>
</div>